---
title: AM2301Bを利用して温湿度を計測する
thumbnail: /images/am2301b/sensor.JPG
twitter_card: summary_large_image
tags:
  - AM2301B
  - NanoPi
  - 温湿度
date: 2021-09-20 23:20:36
---

AM2301Bというセンサを買ってきたのでNanoPi NEO2で動かしてみました．

<!-- more -->

秋月電子: 

[温湿度センサ　モジュール　ＡＭ２３０１Ｂ: センサ一般 秋月電子通商-電子部品・ネット通販](https://akizukidenshi.com/catalog/g/gM-16730/)

データシート: [https://akizukidenshi.com/download/ds/aosong/AM2301B.pdf](https://akizukidenshi.com/download/ds/aosong/AM2301B.pdf)

生産している会社の商品紹介ページ: 

[AM2301B Temperature and humidity sensor-RH&T Sensors-Guangzhou Aosong Electronic Co., Ltd.]()

精度は温度: ±0.3℃, 湿度: ±2%RH(25℃) です．



## ⚙ NanoPiの設定

NanoPiとAM2301BはI2Cで通信します．

あらかじめNanoPi側でI2Cを有効化しておきます．NanoPiでArmbianを動かしているなら，

```
$ sudo armbian-config
```

System > Hardware > i2c0 にスペースキーで✅をいれます．EnterでSaveします．

![](/images/am2301b/i2c-setting.png)

## 🔌 NanoPiとAM2301Bを繋ぐ

![](/images/am2301b/nanopi-pins.png)

右上内側のOUT - 3.3V，SDA，SCL，GNDを利用します．

![](/images/am2301b/connect.JPG)



i2c-toolsで正しく接続できているかを確認します．

```
$ sudo apt-get install i2c-tools
$ sudo i2cdetect -y 0
```

で

```
0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- -- 
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
30: -- -- -- -- -- -- -- -- 38 -- -- -- -- -- -- -- 
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
70: -- -- -- -- -- -- -- --
```

と返ってこれば成功です．

## ⚡️ Pythonで通信する

smbusというライブラリでI2C通信を行います．

```
$ sudo apt-get install python3-smbus
```

適当にデータシートを読みながらコードを書いていきます．今回はCRC checkには目を瞑ることとします．誤差との兼ね合いはお好みで(もうちょっと細かくてもいい気がする)．

```python
import smbus
import time

# i2cバスの番号
i2c = smbus.SMBus(0)
# デバイスアドレス
addr = 0x38

# デバイスの状態確認
status = i2c.read_byte_data(addr, 0x71)
if status != 0x18:
    # 初期化指示
    i2c.write_i2c_block_data(addr, 0xBE, [0x08, 0x00])

    time.sleep(0.1)

    status = i2c.read_byte_data(addr, 0x71)
    
    if status != 0x18:
        print("Device initialization failed.")
        exit()

# 計測指示
i2c.write_i2c_block_data(addr, 0xAC, [0x33, 0x00])

# 計測までは80ms以上おく必要がある．
time.sleep(0.2)

# 計測状態確認
status = i2c.read_byte_data(addr, 0x71)

# statusのBit[7]が0なら計測完了
if format(status, '08b')[0] != "0":
    print("計測未完")
    exit()

# 測定結果を読み取り
block = i2c.read_i2c_block_data(addr,0,8)

# 読み取り結果から温度湿度を計算
hum = int(block[1] << 12 | block[2] << 4 | block[3] >> 4) * 100
hum = int(hum >> 20)

temp = int((block[3] & 0b00001111) << 16 | block[4] << 8 | block[5]) * 200
temp = float(temp >> 18) / 4
temp -= 50

print("T:", temp, " H:", hum)

```

それっぽい値が取得できました．よかった〜

![](/images/am2301b-get-value/success.png)

初期化の方法はデータシートに載っていませんでしたが[別のPDF](https://www.aosong.com/userfiles/files/media/AM2301B%E8%8B%B1%E6%96%87%E7%89%88_%E5%8E%BB%E6%BB%A4%E6%B3%A2%20%E4%B8%8A%E6%8B%89.pdf)には掲載されていました．



### InfluxDB + Grafana

InfluxDBに投げつけてGrafanaで可視化したらいい感じになります．

センサの場所を固定してないためか急に変動する時間が発生してますね・・・．

様子見して設置場所とか精度をどこまで求めるかなどを調整した方が良さそうです．

![Grafana](/images/am2301b/grafana.png)



### 感想

秋葉原の秋月にふらっとよって手に取った温湿度センサでしたが発売直後すぎてデータシート以外の情報がなくうろたえました．(2021.08.31発売 / 2021.09.10購入)

I2Cを利用したことがなかったので完全に手探りでしたが値が取れてよかったです．(間違ってたら指摘をお願いします...)

